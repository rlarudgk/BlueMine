<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<
<c:if test="${not empty message }">
	alert(${message});	
</c:if>

	<div class="modal-content">
		<!-- 모달 바디 부분 -->
		<div class="modal-body m-3">
		<form name="issue" id="issueForm" enctype="multipart/form-data" method="post">
			<table class="table table-bordered">
				<tr>
					<th>
						<spring:message code="issue.issTitle" />
					</th>
					<td>
						<input type="text" name="issTitle" id="issTitle" Class="form-control"  />
					</td>
				</tr>
				<tr>
					<th>
						<spring:message code="issue.workNo" />
					</th>
					<td>
						<select id="workNo" name="work.workNo" class="form-control">
							<c:forEach items="${workList }" var="work">
								<option value="${work.workNo}">${work.workTitle }</option>
							</c:forEach>
						</select>
					</td>
				</tr>
				<tr>
					<th>
						<spring:message code="member.memName" />
					</th>
					<td>

						<select id="memName" name="issChargerList.memEmail" class="form-control" multiple size="3">
						</select>
						<div id="issNames"></div>
					</td>
				</tr>
				<tr>
					<th><spring:message code="issue.issEmerCd" /></th>
					<td>
						<select id="issEmerCd" name="issEmerCd">
							<option value="IE001">긴급</option>
							<option value="IE002">보통</option>
							<option value="IE003" selected>낮음</option>
						</select>
					</td>
				</tr>	
				<tr>
					<th>첨부파일</th>
					<td>
					
					</td>
				</tr>
				<tr>	
					<th><spring:message code="issue.issLabelCd" /></th>
					<td>
						<select name="issLabelCd" class="form-control">
							<option value="IL001">Question</option>
							<option value="IL002">Bug</option>
							<option value="IL003">Help</option>
							<option value="IL004" selected>Notice</option>
						</select>
					</td>
				</tr>
				<tr>
					<th><spring:message code="issue.issSdate" /></th>
					<td>
						<input type="date" name="issSdate" id="issSdate" class="form-control"/>
					</td>
				</tr>
				<tr>
					<th><spring:message code="issue.issEedate" /></th>
					<td>
						<input type="date" name="issEedate" id="issEedate"  class="form-control"/>
					</td>
				</tr>
				<tr>
					<th><spring:message code="issue.issCont" /></th>
					<td>
					    <textarea name="issCont" id="issCont" rows="10" cols="80" >
					    </textarea>
					</td>
				</tr>
			</table>
		<button type="button" id="hideModal" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
		<button type=submit class="btn btn-primary">저장</button>
		<input type="hidden" name="issStatusCd" />
		</form>
		</div>
	</div>
	<script>
		// CK EDITOR
		CKEDITOR.replace( 'issCont' );
		
		let optionMemTag = function(i, v){
			return $("<option>").attr("value", v.memEmail).html(v.memName)
		}
			
		// 회원 목록 띄우기
		$(document).ready(function(){
			var workData = $("#workNo").val();
			
			$.ajax({ 
				url : "${pageContext.request.contextPath }/project/issueMemList",
				type : "get",
				data : {workNo:workData},
				dataType : "json",
				success : function(resp) {
// 					console.log("resp : ", resp.memList);
					
					let selectTag = [];
					$.each(resp.memList, function(i,v){
						selectTag.push(optionMemTag(i, v));
					});
					$("#memName").html(selectTag);
				},
				error : function(jqXHR, status, error) {
					console.log(jqXHR);
					console.log(status);
					console.log(error);
				}
			});
		});
			
		$("#memName").on("click", function(event){
// 			let value = $(this).val();
			let name = $(this).find("option:checked").text();
// 			let opName = $(this).data("opName")

			while(name){
				var names = $("<div>").html(name)
				$("#issNames").html(names).css('padding-top','12px');
				break;
// 				let operator = {mail:value,name:name}
// 				opName.push(operator)
// 				console.log(opName);
			}
		})
// 		.data("opName",[]);
		
		// SUBMIT EVENT
		let issueForm = $("#issueForm").on("submit",function(event){
			event.preventDefault();
			
			// 날짜 계산 후 상태 넣기
			let issSdate = $("[name=issSdate]").val();
			let today = new Date();
			
			let Stoday = today.getFullYear() +
					'-' + ( (today.getMonth()+1) < 9 ? "0" + (today.getMonth()+1) : (today.getMonth()+1) )+
					'-' + ( (today.getDate()) < 9 ? "0" + (today.getDate()) : (today.getDate()) );
			let status = "";
			  if(issSdate > today){
				  status = "IS002";
			  }else{
			    status = "IS003";
			  }
			$("[name=issStatusCd]").val(status);
			
			  
			// INSERT 작업
			let data = issueForm.serialize();
			console.log("data : ", data);
			
			$.ajax({
				url : "${pageContext.request.contextPath }/project/issueForm",
				type : "post",
				data : data,
				dataType : "json",
				success : function(resp) {
					console.log("resp : ", resp);
					console.log("message", resp.message);
					// 모달 숨기기
					$("#hideModal").trigger("click");
					
				},
				error : function(jqXHR, status, error) {
					console.log(jqXHR);
					console.log(status);
					console.log(error);
				}
			});
			$(".isCont").val('');
			return false;
		});

	</script>
				