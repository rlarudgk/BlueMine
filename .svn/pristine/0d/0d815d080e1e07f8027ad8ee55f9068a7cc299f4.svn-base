<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.project.work.dao.WorkDAO">

	<!-- issue 작업목록 조회 -->
	<select id="selectISWork" resultType="WorkVO" parameterType="String">
		SELECT 
		    A.WORK_TITLE
		    , A.WORK_NO
		FROM WORK A, WORK_CHARGER B 
		WHERE A.WORK_NO = B.WORK_NO
		AND B.MEM_EMAIL=#{memEmail,jdbcType=VARCHAR}
	</select>
	
	
	<!-- issue 회원목록 조회 -->
	<select id="selectISMember" parameterType="int" resultType="MemberVO">
		SELECT 
		     B.MEM_NAME
		     , B.MEM_EMAIL
		FROM WORK_CHARGER A, MEMBER B 
		WHERE A.MEM_EMAIL = B.MEM_EMAIL
		AND A.WORK_NO= #{workNo,jdbcType=NUMERIC}
	</select>
	
	<!-- 작업 리스트 조회 -->
	<resultMap type="WorkVO" id="workMap" autoMapping="true">
		<id property="workNo" column="WORK_NO"/>
		<collection property="workChargerList" ofType="WorkChargerVO" autoMapping="true"></collection>
	</resultMap>

	<select id="selectWorkList" parameterType="string" resultMap="workMap">
	
		SELECT
		    A.WORK_NO,
		    A.PRO_CODE,
		    A.WORK_PNT_NO,
		    A.WORK_TITLE,
		    A.WORK_DETAIL,
		    TO_CHAR(WORK_SDATE,'YYYY-MM-DD') AS WORK_SDATE,
		    TO_CHAR(WORK_EDATE,'YYYY-MM-DD') AS WORK_EDATE,
		    A.WORK_STATE_CD,
		    A.WORK_ORDER_CD,
		    B.MEM_EMAIL,
		    B.WORK_PROGRESS
		FROM
		    WORK A INNER JOIN WORK_CHARGER B ON A.WORK_NO = B.WORK_NO
		WHERE PRO_CODE = #{proCode}
		ORDER BY WORK_NO DESC
	
	</select>
	
	<select id="selectMyWorkList" parameterType="WorkVO" resultMap="workMap">
		SELECT
		    A.WORK_NO,
		    A.PRO_CODE,
		    A.WORK_PNT_NO,
		    A.WORK_TITLE,
		    A.WORK_DETAIL,
		    A.WORK_SDATE,
		    A.WORK_EDATE,
		    A.WORK_STATE_CD,
		    A.WORK_ORDER_CD,
		    B.MEM_EMAIL,
		    B.WORK_PROGRESS
		FROM
		    WORK A INNER JOIN WORK_CHARGER B ON (A.WORK_NO = B.WORK_NO)
		WHERE PRO_CODE = #{proCode,jdbcType=VARCHAR}
		AND B.MEM_EMAIL = #{memEmail,jdbcType=VARCHAR}
	</select>
	
	<!-- 작업 자세히보기 -->
	<select id="selectWorkDetail" parameterType="WorkVO" resultMap="workMap">
	
		SELECT
		    A.WORK_NO,
		    A.PRO_CODE,
		    A.WORK_PNT_NO,
		    A.WORK_TITLE,
		    A.WORK_DETAIL,
		    TO_CHAR(WORK_SDATE,'YYYY-MM-DD') AS WORK_SDATE,
		    TO_CHAR(WORK_EDATE,'YYYY-MM-DD') AS WORK_EDATE,
		    A.WORK_STATE_CD,
		    A.WORK_ORDER_CD,
		    B.MEM_EMAIL,
		    B.WORK_PROGRESS
		FROM
		    WORK A INNER JOIN WORK_CHARGER B ON A.WORK_NO = B.WORK_NO
		WHERE PRO_CODE = #{proCode,jdbcType=VARCHAR}
		AND A.WORK_NO = #{workNo,jdbcType=NUMERIC}
	
	</select>
	
	<!-- 작업 등록 -->
	<insert id="insertWork" parameterType="WorkVO">
	
		INSERT INTO WORK (
		    WORK_NO,
		    PRO_CODE,
		    WORK_PNT_NO,
		    WORK_TITLE,
		    WORK_DETAIL,
		    WORK_SDATE,
		    WORK_EDATE,
		    WORK_STATE_CD,
		    WORK_ORDER_CD
		) VALUES (
		    WORK_SEQ.NEXTVAL
		    , #{proCode,jdbcType=VARCHAR}
			, 1
			, #{workTitle,jdbcType=VARCHAR}
			, 'hi'
			, #{workSdate,jdbcType=DATE}
			, #{workEdate,jdbcType=DATE}
			, #{workStateCd,jdbcType=VARCHAR}
			, #{workOrderCd,jdbcType=VARCHAR}
		)

	</insert>
	
	
	<!-- 마지막 작업 No 값 가져오기 -->
	<select id="selectWorkLastNo" resultType="WorkVO">
	
		SELECT (SELECT 
            		LAST_NUMBER 
         		  FROM 
           		 	USER_SEQUENCES 
       			 WHERE 
           		 	SEQUENCE_NAME = 'WORK_SEQ') AS WORK_NO
		FROM DUAL
		
	</select>
	
	<!-- 작업 담당자 등록 -->
	<insert id="insertWorkCharger" parameterType="WorkVO">
		INSERT ALL
		<foreach collection="workChargerList" item="workCharger" index="idx">
			INTO WORK_CHARGER (
			    WORK_NO
			    , MEM_EMAIL
			    , WORK_PROGRESS
			) VALUES (
			    #{workCharger.workNo,jdbcType=NUMERIC}
			    , #{workCharger.memEmail,jdbcType=VARCHAR}
			    , 0
			)
		</foreach>
		SELECT * FROM DUAL
	</insert>
	
</mapper>